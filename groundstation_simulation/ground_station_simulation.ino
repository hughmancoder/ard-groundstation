#include <LiquidCrystal_I2C.h>
#include <Wire.h>

// Initialize the I2C LCD with the address 0x27 and 16x2 display size
LiquidCrystal_I2C lcd(0x27, 16, 2);

const int ledPin = 2;
bool ledState = false; // Variable to store the current state of the LED

// Define the telemetry data structure
struct TelemetryPacket {
  uint32_t time;                   // 4 bytes
  float bmpTemp;                   // 4 bytes
  float imuTemp;                   // 4 bytes
  float pressure;                  // 4 bytes
  float altitude;                  // 4 bytes
  float accX, accY, accZ;          // 12 bytes
  float angVelX, angVelY, angVelZ; // 12 bytes
} __attribute__((packed));         // Ensure no padding in the structure

// Sample telemetry data
TelemetryPacket data[] = {{3174262, 23.99, 29.63, 99494.90, 153.49, -0.61,
                           -0.30, 10.06, 0.02, 0.04, 0.06},
                          {3174509, 24.00, 29.53, 99490.29, 153.88, -0.17,
                           -0.26, 10.04, 0.05, 0.02, -0.02},
                          {3174756, 24.00, 29.67, 99486.91, 154.17, -0.17,
                           -0.22, 9.96, 0.02, 0.03, -0.08},
                          {3175002, 24.00, 29.72, 99493.73, 153.59, -0.42,
                           -0.11, 9.99, 0.01, 0.04, -0.01},
                          {3175249, 24.00, 29.63, 99494.84, 153.50, -0.15,
                           -0.28, 9.95, 0.04, 0.02, -0.01},
                          {3175495, 24.00, 29.53, 99491.46, 153.79, -0.31,
                           -0.04, 9.95, 0.02, 0.02, -0.04},
                          {3175742, 24.00, 29.72, 99489.13, 153.98, -0.57,
                           -0.37, 9.98, 0.01, 0.02, -0.02},
                          {3175988, 24.00, 29.67, 99486.85, 154.18, -0.17,
                           -0.23, 10.04, 0.03, 0.03, 0.01},
                          {3176235, 24.00, 29.63, 99490.29, 153.88, -0.49,
                           -0.03, 10.07, 0.03, 0.01, -0.03},
                          {3176481, 24.00, 29.72, 99494.84, 153.50, -0.29,
                           -0.12, 9.96, 0.01, 0.02, -0.11},
                          {3176728, 24.00, 29.63, 99489.13, 153.98, -0.55,
                           -0.30, 9.94, 0.03, 0.04, -0.03},
                          {3176975, 24.00, 29.87, 99493.66, 153.60, -0.26,
                           -0.19, 10.05, 0.03, 0.01, 0.07},
                          {3177221, 24.01, 29.53, 99494.77, 153.51, 0.01, -0.11,
                           10.02, 0.03, 0.04, -0.01},
                          {3177467, 24.00, 29.53, 99486.85, 154.18, -0.44,
                           -0.21, 10.01, 0.04, 0.03, -0.03},
                          {3177714, 24.01, 29.63, 99487.95, 154.08, -0.61,
                           -0.11, 10.00, 0.03, 0.02, -0.01},
                          {3177961, 24.01, 29.48, 99491.33, 153.80, -0.42, 0.06,
                           10.03, 0.02, 0.03, -0.03},
                          {3178209, 24.01, 29.63, 99481.13, 154.66, -0.34,
                           -0.18, 9.94, 0.01, 0.02, 0.02},
                          {3178456, 24.01, 29.72, 99487.95, 154.08, -0.33,
                           -0.25, 10.02, 0.03, 0.02, -0.07},
                          {3178702, 24.02, 29.63, 99495.81, 153.42, -0.30,
                           -0.25, 9.98, 0.04, 0.03, -0.03},
                          {3178949, 24.01, 29.48, 99491.33, 153.80, -0.15, 0.01,
                           10.03, 0.04, 0.03, 0.12},
                          {3179195, 24.01, 30.01, 99486.79, 154.18, -0.29,
                           -0.02, 9.97, 0.02, 0.02, -0.02},
                          {3179442, 24.01, 29.67, 99494.77, 153.51, -0.26,
                           -0.29, 10.06, -0.01, 0.00, -0.02},
                          {3179688, 24.01, 29.67, 99490.23, 153.89, -0.34,
                           -0.70, 10.07, 0.02, 0.03, -0.07},
                          {3179935, 24.01, 29.87, 99479.97, 154.76, -0.38,
                           -0.24, 9.99, 0.06, 0.03, -0.11},
                          {3180182, 24.01, 29.63, 99485.68, 154.27, -0.14,
                           -0.11, 10.01, 0.03, 0.05, -0.01},
                          {3180428, 24.02, 29.82, 99491.27, 153.80, -0.41,
                           -0.20, 10.04, 0.01, 0.02, 0.04},
                          {3180675, 24.03, 29.53, 99492.38, 153.71, -0.29,
                           -0.33, 10.02, 0.01, 0.00, 0.12},
                          {3180921, 24.02, 29.63, 99492.44, 153.70, -0.12,
                           -0.17, 10.08, 0.02, 0.03, -0.03},
                          {3181168, 24.02, 29.63, 99488.99, 153.99, -0.56, 0.19,
                           10.00, 0.04, 0.05, -0.12},
                          {3181414, 24.02, 29.72, 99488.99, 153.99, -0.18, 0.03,
                           10.00, 0.02, 0.03, 0.03},
                          {3181661, 24.02, 29.72, 99491.27, 153.80, -0.19,
                           -0.06, 10.01, 0.04, 0.02, 0.02},
                          {3181907, 24.02, 29.87, 99485.62, 154.28, -0.34,
                           -0.34, 10.04, 0.03, 0.04, -0.01},
                          {3182153, 24.02, 29.67, 99495.81, 153.42, -0.51,
                           -0.56, 9.96, 0.02, 0.02, 0.01},
                          {3182400, 24.02, 29.72, 99493.54, 153.61, -0.11,
                           -0.47, 10.14, 0.02, 0.01, -0.13},
                          {3182646, 24.03, 29.67, 99487.83, 154.09, -0.03,
                           -0.33, 10.07, 0.02, 0.03, 0.09},
                          {3182893, 24.04, 29.82, 99484.32, 154.39, -0.44,
                           -0.48, 10.00, 0.03, 0.03, 0.22},
                          {3183139, 24.03, 29.53, 99483.28, 154.48, -0.32, 0.07,
                           9.99, 0.06, 0.03, 0.00},
                          {3183386, 24.03, 29.96, 99487.83, 154.09, -0.24, 0.43,
                           10.01, 0.01, 0.02, 0.00},
                          {3183632, 24.03, 29.67, 99491.20, 153.81, -0.47,
                           -0.11, 10.00, 0.00, 0.03, 0.02},
                          {3183878, 24.03, 29.87, 99479.84, 154.77, -0.41,
                           -0.11, 10.04, 0.03, 0.02, -0.01},
                          {3184125, 24.03, 29.67, 99481.01, 154.67, -0.29, 0.08,
                           9.99, 0.03, 0.02, -0.08},
                          {3184371, 24.04, 29.63, 99487.77, 154.10, -0.39,
                           -0.17, 9.97, 0.01, 0.01, -0.07},
                          {3184617, 24.04, 29.63, 99485.49, 154.29, 0.00, -0.67,
                           9.90, -0.03, 0.02, 0.19},
                          {3184864, 24.03, 29.53, 99488.93, 154.00, 1.36, 2.66,
                           97.06, 0.20, 0.19, -1.11},
                          {3185110, 24.03, 29.67, 99528.74, 150.64, -4.32, 3.51,
                           109.20, 0.04, 0.13, -0.55},
                          {3185357, 24.04, 29.53, 99374.11, 163.71, 2.22, -0.50,
                           102.98, -0.27, -0.79, 0.59},
                          {3185604, 24.04, 29.96, 99211.55, 177.46, -1.01, 4.88,
                           98.07, 0.09, 0.07, 3.33},
                          {3185852, 24.04, 29.53, 98937.70, 200.68, -0.73, 1.28,
                           91.54, -0.09, -0.07, 6.60},
                          {3186098, 24.04, 29.63, 98549.05, 233.72, 4.06, 5.91,
                           86.36, -0.16, -0.46, 9.81},
                          {3186345, 24.04, 29.63, 98095.62, 272.41, 1.00, 11.20,
                           81.48, 0.02, -0.59, 12.63},
                          {3186591, 24.03, 29.87, 97588.97, 315.80, -1.45,
                           11.08, 75.80, 0.29, -0.33, 14.06},
                          {3186838, 24.03, 29.82, 96986.87, 367.61, 2.32, 12.98,
                           68.92, 0.15, -0.26, 15.50},
                          {3187085, 24.01, 29.87, 96339.66, 423.59, 3.04, 15.68,
                           64.19, 0.32, -0.38, 16.83},
                          {3187331, 24.01, 29.63, 95660.52, 482.66, 4.17, 15.19,
                           59.32, 0.18, -0.30, 18.13},
                          {3187578, 24.01, 29.63, 94934.98, 546.14, 1.95, 18.01,
                           56.41, 0.21, -0.38, 19.36},
                          {3187824, 24.00, 29.72, 94166.60, 613.80, 0.79, 20.82,
                           44.02, 0.27, -0.33, 20.40},
                          {3188071, 23.99, 29.96, 93351.76, 686.04, -5.63,
                           21.64, -3.80, 0.42, -0.21, 20.56},
                          {3188317, 23.98, 29.63, 92714.12, 742.93, 1.52, 16.82,
                           -21.62, 0.29, -0.13, 19.64},
                          {3188564, 23.99, 29.53, 92309.92, 779.15, 4.56, 13.95,
                           -27.37, 0.31, -0.31, 19.07},
                          {3188811, 23.97, 29.53, 92029.95, 804.32, -1.18,
                           15.09, -20.37, 0.27, -0.22, 18.77},
                          {3189057, 23.96, 29.63, 91658.00, 837.85, -3.14,
                           13.70, -21.69, 0.22, -0.06, 18.13},
                          {3189304, 23.97, 29.63, 91333.30, 867.21, 1.71, 13.41,
                           -23.48, 0.32, -0.20, 17.20},
                          {3189550, 23.97, 29.67, 91001.00, 897.35, -0.73,
                           11.16, -16.91, 0.12, -0.19, 16.63},
                          {3189797, 23.96, 29.53, 90684.62, 926.12, 0.57, 8.42,
                           -17.24, 0.09, -0.05, 15.71},
                          {3190043, 23.96, 29.63, 90362.46, 955.51, 2.19, 7.30,
                           -14.49, 0.20, -0.06, 15.10},
                          {3190290, 23.96, 29.53, 90021.17, 986.73, 0.42, 5.61,
                           -13.89, 0.09, -0.11, 14.43},
                          {3190536, 23.97, 29.87, 89712.42, 1015.06, 1.90, 8.81,
                           -13.31, 0.13, -0.03, 13.90},
                          {3190783, 23.96, 29.48, 89405.20, 1043.33, 1.06, 6.45,
                           -9.28, 0.15, -0.12, 13.38},
                          {3191029, 23.97, 29.48, 89119.15, 1069.72, -0.32,
                           7.03, -12.02, 0.14, -0.07, 12.80},
                          {3191276, 23.96, 29.53, 88804.16, 1098.86, 1.77, 3.77,
                           -10.15, 0.02, 0.07, 12.13},
                          {3191523, 23.97, 29.48, 88551.16, 1122.32, 1.82, 5.39,
                           -8.26, 0.20, -0.12, 11.83},
                          {3191769, 23.97, 29.53, 88284.55, 1147.11, 0.79, 4.03,
                           -7.74, 0.04, 0.00, 11.20},
                          {3192016, 23.98, 29.63, 88015.68, 1172.17, 1.56, 3.51,
                           -8.82, 0.12, 0.00, 10.86},
                          {3192262, 23.98, 29.43, 87752.63, 1196.74, 0.94, 3.65,
                           -8.05, 0.11, -0.08, 10.48},
                          {3192509, 23.97, 29.82, 87508.04, 1219.65, 1.51, 3.41,
                           -7.16, 0.09, 0.07, 9.96},
                          {3192755, 23.97, 29.72, 87282.29, 1240.83, 1.25, 4.12,
                           -6.66, 0.06, 0.05, 9.55},
                          {3193002, 23.97, 29.63, 87045.51, 1263.10, 0.78, 2.91,
                           -6.10, 0.03, -0.06, 9.25},
                          {3193248, 23.97, 29.53, 86837.91, 1282.67, 1.16, 2.54,
                           -6.18, -0.08, 0.07, 8.84},
                          {3193497, 23.98, 29.63, 86621.24, 1303.13, 0.34, 2.63,
                           -5.08, 0.07, -0.05, 8.52},
                          {3193743, 23.98, 29.82, 86417.20, 1322.43, 0.13, 2.91,
                           -5.34, 0.10, -0.02, 8.22},
                          {3193990, 23.97, 29.72, 86213.50, 1341.74, -0.47,
                           2.02, -4.77, 0.03, 0.06, 7.83},
                          {3194237, 23.97, 29.63, 86019.52, 1360.17, 0.90, 1.74,
                           -4.07, -0.03, 0.08, 7.43},
                          {3194483, 23.98, 29.53, 85835.59, 1377.67, 0.50, 1.78,
                           -3.92, 0.00, -0.12, 7.28},
                          {3194730, 23.98, 29.53, 85673.68, 1393.10, 0.93, 1.51,
                           -3.63, 0.00, 0.03, 7.01},
                          {3194976, 23.97, 29.63, 85509.52, 1408.77, 0.49, 1.53,
                           -3.10, 0.06, 0.07, 6.74},
                          {3195222, 23.98, 29.67, 85352.78, 1423.75, 0.61, 2.00,
                           -2.80, 0.06, -0.02, 6.47},
                          {3195469, 23.98, 29.48, 85204.49, 1437.94, 0.22, 1.28,
                           -2.66, 0.04, -0.08, 6.23},
                          {3195715, 23.99, 29.63, 85069.12, 1450.92, 0.53, 0.84,
                           -2.56, 0.06, 0.10, 5.90},
                          {3195961, 23.98, 29.63, 84917.61, 1465.46, 0.26, 1.12,
                           -2.20, 0.01, 0.14, 5.59},
                          {3196208, 23.98, 29.63, 84801.06, 1476.66, 0.74, 0.72,
                           -2.17, 0.05, 0.02, 5.36},
                          {3196454, 23.99, 29.63, 84671.53, 1489.13, 0.48, 1.02,
                           -1.69, 0.03, -0.11, 5.21},
                          {3196700, 23.99, 29.53, 84560.48, 1499.83, 0.44, 0.57,
                           -1.53, -0.08, -0.03, 4.99},
                          {3196947, 24.00, 29.63, 84453.61, 1510.13, 0.34, 0.42,
                           -1.60, -0.14, 0.03, 4.72},
                          {3197193, 23.99, 29.53, 84345.19, 1520.60, 0.58, 0.71,
                           -1.34, 0.00, 0.08, 4.52},
                          {3197440, 24.00, 29.29, 84256.45, 1529.18, 0.61, 0.93,
                           -1.25, 0.10, -0.05, 4.42},
                          {3197686, 24.00, 29.63, 84164.48, 1538.07, 0.19, 0.77,
                           -1.16, 0.12, -0.11, 4.24},
                          {3197932, 23.99, 29.43, 84081.00, 1546.15, 0.41, 0.55,
                           -1.04, 0.06, -0.14, 4.04},
                          {3198179, 23.99, 29.63, 84006.22, 1553.39, 0.20, 0.25,
                           -0.84, -0.11, -0.05, 3.84},
                          {3198425, 23.99, 29.29, 83931.44, 1560.64, -0.22,
                           0.76, -0.92, -0.13, 0.18, 3.56},
                          {3198671, 24.00, 29.29, 83868.94, 1566.71, 0.24, 0.17,
                           -0.82, 0.14, 0.18, 3.42},
                          {3198917, 24.00, 29.43, 83807.38, 1572.68, -0.03,
                           0.37, -0.64, 0.11, 0.19, 3.17},
                          {3199164, 24.00, 29.63, 83755.63, 1577.71, 0.36, 0.38,
                           -0.61, 0.22, 0.04, 3.07},
                          {3199411, 24.00, 29.67, 83706.73, 1582.46, 0.28, 0.75,
                           -0.61, 0.27, -0.19, 3.03},
                          {3199657, 24.00, 29.63, 83675.95, 1585.45, 0.24, 0.35,
                           -0.46, 0.16, -0.36, 2.96},
                          {3199904, 24.00, 29.67, 83638.75, 1589.07, 0.04,
                           -0.01, -0.37, -0.13, -0.27, 2.79},
                          {3200150, 24.00, 29.63, 83605.70, 1592.28, -0.25,
                           0.27, -0.41, -0.24, -0.03, 2.62},
                          {3200397, 24.00, 29.63, 83576.25, 1595.15, -0.02,
                           0.10, -0.49, -0.17, 0.20, 2.48},
                          {3200644, 24.01, 29.63, 83563.59, 1596.38, -0.02,
                           -0.22, -0.40, -0.11, 0.33, 2.35},
                          {3200890, 24.01, 29.53, 83547.73, 1597.92, -0.16,
                           -0.04, -0.39, -0.08, 0.45, 2.23},
                          {3201138, 24.00, 29.63, 83539.05, 1598.77, -14.34,
                           -28.67, 162.39, 0.20, 0.73, 2.36}};

void setup() {
  Serial.begin(115200); // Initialize serial communication
  pinMode(ledPin, OUTPUT);

  // Initialize LCD
  lcd.init();
  lcd.backlight();

  // Display a startup message on the LCD
  lcd.setCursor(0, 0);
  lcd.print("Telemetry Ready");
  delay(2000);
  lcd.clear();
}

void loop() {
  static unsigned int index = 0; // Track the current data index

  // Display the current telemetry data on the LCD
  lcd.setCursor(0, 0);
  lcd.print("Simulation data");
  lcd.setCursor(0, 1);
  lcd.print("Time: ");
  lcd.print(data[index].time);

  // Send the telemetry data as a binary stream
  Serial.write((uint8_t *)&data[index], sizeof(TelemetryPacket));

  // Toggle LED for visual indicator
  ledState = !ledState;
  digitalWrite(ledPin, ledState ? HIGH : LOW);

  // Move to the next telemetry data entry
  index++;
  if (index >= sizeof(data) / sizeof(data[0])) {
    index = 0; // Wrap around to the first entry
  }

  delay(1000); // Simulate 1-second telemetry updates
}